<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live –ó–∞–¥–∞—á–∏</title>
  <style>
    table { width:100%; border-collapse:collapse; margin-top:20px }
    th,td { border:1px solid #ccc; padding:8px; text-align:left }
    th { background:#f0f0f0 }
    tr.new-task { background:#e8f7e4 }
    tr.assigned-task { background:#fff3cd }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
  </style>
</head>
<body
  data-pool-id="{{ pool_id }}"
  data-fallback-url="{% url 'task-list' %}"
>
  <h1>üî• Live –ó–∞–¥–∞—á–∏</h1>

  <table id="taskTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–°–º–µ–Ω–∞</th>
        <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
        <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const tbody = document.querySelector("#taskTable tbody");
    const poolId = (document.body.dataset.poolId || "").trim();
    const fallbackUrl = document.body.dataset.fallbackUrl;

    // –ï—Å–ª–∏ poolId –µ—Å—Ç—å ‚Äî –±–µ—Ä—ë–º –∑–∞–¥–∞—á–∏ –∏–∑ –ø—É–ª–∞, –∏–Ω–∞—á–µ ‚Äî –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ (—Ñ–æ–ª–±—ç–∫)
    const API_BASE = poolId ? `/api/task-pools/${poolId}/tasks/` : fallbackUrl;

    // –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã (—Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä –∏ —Ç–∞–∫ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ—Ç)
    const ALLOWED_STATUSES = new Set(["new","assigned","accepted","in_progress","pending"]);

    function formatEmployee(emp){
      if (emp == null) return "-";
      if (typeof emp === "number" || typeof emp === "string") return `#${emp}`;
      const code = emp.employee_code ?? emp.code ?? "";
      const name = [emp.first_name ?? "", emp.last_name ?? ""].join(" ").trim();
      return (code ? code + (name ? " ‚Äî " : "") : "") + (name || (code ? "" : "-"));
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ —Å–º–µ–Ω—ã ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç id, —Å—Ç—Ä–æ–∫—É, –æ–±—ä–µ–∫—Ç, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—è
    function formatShift(task){
      const s = task.shift ?? task.shift_obj ?? task.shift_info ?? null;

      // –µ—Å–ª–∏ –ø—Ä–∏—à—ë–ª –ø—Ä–æ—Å—Ç–æ id/—Å—Ç—Ä–æ–∫–∞
      if (typeof s === "number" || typeof s === "string") return `#${s}`;

      // –µ—Å–ª–∏ –ø—Ä–∏—à—ë–ª –æ–±—ä–µ–∫—Ç
      if (s && (s.id || s.name || s.date)) {
        const id = s.id ? `#${s.id}` : "";
        const name = s.name ?? "";
        const date = s.date ? `(${s.date})` : "";
        const parts = [id, name, date].filter(Boolean);
        return parts.length ? parts.join(" ") : "-";
      }

      // –µ—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –æ—Ç–¥–∞–ª —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
      const sid = task.shift_id ?? task.shift_pk ?? null;
      const sname = task.shift_name ?? task.shift_title ?? "";
      const sdate = task.shift_date ?? "";
      const parts = [];
      if (sid) parts.push(`#${sid}`);
      if (sname) parts.push(sname);
      if (sdate) parts.push(`(${sdate})`);
      return parts.length ? parts.join(" ") : "-";
    }

    function pickTitle(t){ return (t.title ?? t.name ?? "").toString().trim() || "-"; }
    function pickDescription(t){ return (t.description ?? "").toString().trim() || "-"; }
    function pickSource(t, row){
      // –ë–µ—Ä—ë–º —Å—Ç—Ä–æ–≥–æ –∏–∑ –º–æ–¥–µ–ª–∏: source / task_source / origin. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–∂–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —è—á–µ–π–∫–µ, –∏–Ω–∞—á–µ "-"
      const modelSource = t.source ?? t.task_source ?? t.origin;
      if (modelSource != null && String(modelSource).trim() !== "") return String(modelSource);
      if (row) {
        const cell = row.querySelector("td:nth-child(7)");
        if (cell && cell.textContent) return cell.textContent;
      }
      return "-";
    }
    function getRow(id){ return tbody.querySelector(`tr[data-task-id="${id}"]`); }

    function upsertRow(t){
      const id = t.id ?? t.pk; if (id == null) return;
      const status = t.status ?? "-";
      if (!ALLOWED_STATUSES.has(status)){
        if (status === "completed"){ const r = getRow(String(id)); if (r) r.remove(); }
        return;
      }

      let row = getRow(id);
      if (!row){
        row = document.createElement("tr");
        row.dataset.taskId = id;
        tbody.prepend(row);
      }

      const employeeObj = t.assigned_to ?? t.employee ?? null;
      const isInProgress = (status === "in_progress");

      row.classList.toggle("assigned-task", isInProgress || !!employeeObj);
      row.classList.toggle("new-task", !(isInProgress || !!employeeObj));

      const src = pickSource(t, row);

      row.innerHTML = `
        <td class="mono">${id}</td>
        <td>${pickTitle(t)}</td>
        <td>${pickDescription(t)}</td>
        <td>${status}</td>
        <td>${formatShift(t)}</td>
        <td>${formatEmployee(employeeObj)}</td>
        <td>${src}</td>
      `;
    }

    // 1) –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ ‚Äî –¢–û–õ–¨–ö–û –∏–∑ –ø—É–ª–∞ (–∏–ª–∏ —Ñ–æ–ª–±—ç–∫)
    fetch(API_BASE)
      .then(r => r.json())
      .then(items => {
        const list = Array.isArray(items) ? items : (items.results || []);
        list.filter(t => ALLOWED_STATUSES.has(t.status)).forEach(upsertRow);
        console.log(`–ó–∞–¥–∞—á–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ ${poolId ? "–ø—É–ª–∞ #"+poolId : "–æ–±—â–µ–≥–æ —Å–ø–∏—Å–∫–∞"}:`, list.length);
      })
      .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err));

    // 2) WebSocket ‚Äî –¥–µ–ª—å—Ç—ã
    const WS_PATH = "/ws/tasks/";
    function connectWS(){
      const scheme = location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${scheme}://${location.host}${WS_PATH}`);
      ws.onopen  = () => console.log("WS: connected");
      ws.onerror = (e) => console.error("WS error:", e);
      ws.onclose = () => { console.warn("WS closed, retry in 2s‚Ä¶"); setTimeout(connectWS, 2000); };
      ws.onmessage = (e) => {
        let data; try { data = JSON.parse(e.data) } catch { return }
        if (data?.reason === "—Å–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"){ tbody.innerHTML = ""; return }
        if (data?.reason === "–∑–∞–≤–µ—Ä—à–µ–Ω–æ" || data?.status === "completed"){
          const row = getRow(String(data.id)); if (row) row.remove(); return
        }
        if (data && data.id != null){
          if (!ALLOWED_STATUSES.has(data.status)) return;
          upsertRow(data);
        }
      }
    }
    connectWS();
  </script>
</body>
</html>
