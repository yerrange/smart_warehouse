<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ó–∞–¥–∞—á–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</title>
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    tr.new-task { background-color: #e8f7e4; }
    tr.assigned-task { background-color: #fff3cd; }
  </style>
</head>
<body>
  <h1>üî• Live –ó–∞–¥–∞—á–∏</h1>
  <table id="taskTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
        <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const socket = new WebSocket("ws://" + window.location.host + "/ws/tasks/");
    const tbody = document.querySelector("#taskTable tbody");

    socket.onopen = () => {
      console.log("‚úÖ WebSocket —Å–æ–µ–¥–∏–Ω—ë–Ω");
    };

    socket.onmessage = function(event) {
      console.log("üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", event.data);

      let data;
      try {
        data = JSON.parse(event.data);
      } catch (e) {
        console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON:", e);
        return;
      }

      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${data.id ?? data.task_id ?? "-"}</td>
        <td>${data.name ?? data.description ?? "-"}</td>
        <td>${data.status ?? "-"}</td>
        <td>${data.employee?.name ?? data.assigned_to ?? "-"}</td>
        <td>${data.reason ?? "–±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã"}</td>
      `;

      if (data.employee || data.assigned_to) {
        row.classList.add("assigned-task");
      } else {
        row.classList.add("new-task");
      }

      tbody.prepend(row);
    };

    socket.onerror = function(error) {
      console.error("üîå –û—à–∏–±–∫–∞ WebSocket:", error);
    };

    socket.onclose = function(event) {
      console.warn("üîí WebSocket –∑–∞–∫—Ä—ã—Ç:", event);
    };
  </script>
</body>
</html>
