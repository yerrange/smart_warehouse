<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live –ó–∞–¥–∞—á–∏</title>
  <style>
    table { width:100%; border-collapse:collapse; margin-top:20px }
    th,td { border:1px solid #ccc; padding:8px; text-align:left }
    th { background:#f0f0f0 }
    tr.new-task { background:#e8f7e4 }
    tr.assigned-task { background:#fff3cd }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
  </style>
</head>
<body
  data-pool-id="{{ pool_id }}"
  data-fallback-url="{% url 'task-list' %}"
>
  <h1>üî• Live –ó–∞–¥–∞—á–∏</h1>

  <table id="taskTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–°–º–µ–Ω–∞</th>
        <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
        <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const tbody = document.querySelector("#taskTable tbody");
    const poolId = (document.body.dataset.poolId || "").trim();
    const fallbackUrl = document.body.dataset.fallbackUrl;  // /api/tasks/ (–∏–º—è 'task-list')

    // –ï—Å–ª–∏ poolId –µ—Å—Ç—å ‚Äî –±–µ—Ä—ë–º –∑–∞–¥–∞—á–∏ –∏–∑ –ø—É–ª–∞, –∏–Ω–∞—á–µ ‚Äî –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ (—Ñ–æ–ª–±—ç–∫)
    const API_BASE = poolId ? `/api/task-pools/${poolId}/tasks/` : fallbackUrl;

    // –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã (—Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä –∏ —Ç–∞–∫ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ—Ç)
    const ALLOWED_STATUSES = new Set(["new","assigned","accepted","in_progress","pending"]);

    function formatEmployee(emp){
      if(!emp) return "-";
      const code = emp.employee_code ?? emp.code ?? "";
      const name = [emp.first_name ?? "", emp.last_name ?? ""].join(" ").trim();
      return (code ? code + (name ? " ‚Äî " : "") : "") + (name || "-");
    }
    function formatShift(shift){
      if(!shift) return "-";
      const id = shift.id ?? ""; const name = shift.name ?? ""; const date = shift.date ?? "";
      return [id?`#${id}`:"", name, date?`(${date})`:""].filter(Boolean).join(" ");
    }
    function pickTitle(t){ return (t.title ?? t.name ?? "").toString().trim() || "-"; }
    function pickDescription(t){ return (t.description ?? "").toString().trim() || "-"; }
    function getRow(id){ return tbody.querySelector(`tr[data-task-id="${id}"]`); }

    function upsertRow(t, source="Auto"){
      const id = t.id ?? t.pk; if(id == null) return;
      const status = t.status ?? "-";
      if(!ALLOWED_STATUSES.has(status)){
        if(status === "completed"){ const r = getRow(String(id)); if(r) r.remove(); }
        return;
      }
      let row = getRow(id);
      if(!row){
        row = document.createElement("tr");
        row.dataset.taskId = id;
        tbody.prepend(row);
      }
      row.classList.toggle("assigned-task", status==="in_progress" || !!t.assigned_to);
      row.classList.toggle("new-task", !(status==="in_progress" || !!t.assigned_to));
      row.innerHTML = `
        <td class="mono">${id}</td>
        <td>${pickTitle(t)}</td>
        <td>${pickDescription(t)}</td>
        <td>${status}</td>
        <td>${formatShift(t.shift)}</td>
        <td>${formatEmployee(t.assigned_to)}</td>
        <td>${source}</td>
      `;
    }

    // 1) –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ ‚Äî –¢–û–õ–¨–ö–û –∏–∑ –ø—É–ª–∞ (–∏–ª–∏ —Ñ–æ–ª–±—ç–∫)
    fetch(API_BASE)
      .then(r => r.json())
      .then(items => {
        const list = Array.isArray(items) ? items : (items.results || []);
        list.filter(t => ALLOWED_STATUSES.has(t.status)).forEach(t => upsertRow(t, poolId ? "Pool" : "All"));
        console.log(`–ó–∞–¥–∞—á–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ ${poolId ? "–ø—É–ª–∞ #"+poolId : "–æ–±—â–µ–≥–æ —Å–ø–∏—Å–∫–∞"}:`, list.length);
      })
      .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err));

    // 2) WebSocket ‚Äî –∫–∞–∫ –±—ã–ª–æ (—Å—Ç—Ä–∏–º–∏–º –¥–µ–ª—å—Ç—ã)
    const WS_PATH = "/ws/tasks/";
    function connectWS(){
      const scheme = location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${scheme}://${location.host}${WS_PATH}`);
      ws.onopen  = () => console.log("WS: connected");
      ws.onerror = (e) => console.error("WS error:", e);
      ws.onclose = () => { console.warn("WS closed, retry in 2s‚Ä¶"); setTimeout(connectWS, 2000); };
      ws.onmessage = (e) => {
        let data; try{ data=JSON.parse(e.data) }catch{ return }
        if (data?.reason === "—Å–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"){ tbody.innerHTML=""; return }
        if (data?.reason === "–∑–∞–≤–µ—Ä—à–µ–Ω–æ" || data?.status === "completed"){
          const row = getRow(String(data.id)); if(row) row.remove(); return
        }
        if (data && data.id != null){
          if (!ALLOWED_STATUSES.has(data.status)) return;
          upsertRow(data, "WS");
        }
      }
    }
    connectWS();
  </script>
</body>
</html>
